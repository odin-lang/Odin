// Copyright 1995-2016 The OpenSSL Project Authors. All Rights Reserved.
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//     https://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.
package bifrost_tls

import "core:c"

package bifrost_tls

// BoringSSL static libraries (vendored, Linux-only for now).
@(private) LIBSSL_PATH    :: "../../boringssl/lib/libssl.a"
@(private) LIBCRYPTO_PATH :: "../../boringssl/lib/libcrypto.a"

when !#exists(LIBSSL_PATH) {
	#panic("Could not find BoringSSL at \"" + LIBSSL_PATH + "\", build it via `" + ODIN_ROOT + "vendor/boringssl/build_boringssl.sh\"`")
}
when !#exists(LIBCRYPTO_PATH) {
	#panic("Could not find BoringSSL at \"" + LIBCRYPTO_PATH + "\", build it via `" + ODIN_ROOT + "vendor/boringssl/build_boringssl.sh\"`")
}

foreign import ssl {
	LIBSSL_PATH,
}
foreign import crypto {
	LIBCRYPTO_PATH,
}


// OPENSSL_sk_free_func is a function that frees an element in a stack. Note its
// actual type is void (*)(T *) for some T. Low-level |sk_*| functions will be
// passed a type-specific wrapper to call it correctly.
OPENSSL_sk_free_func :: proc "c" (ptr: rawptr)

// OPENSSL_sk_copy_func is a function that copies an element in a stack. Note
// its actual type is T *(*)(const T *) for some T. Low-level |sk_*| functions
// will be passed a type-specific wrapper to call it correctly.
OPENSSL_sk_copy_func :: proc "c" (ptr: rawptr) -> rawptr

// OPENSSL_sk_cmp_func is a comparison function that returns a value < 0, 0 or >
// 0 if |*a| is less than, equal to or greater than |*b|, respectively.  Note
// the extra indirection - the function is given a pointer to a pointer to the
// element. This differs from the usual qsort/bsearch comparison function.
//
// Note its actual type is |int (*)(const T *const *a, const T *const *b)|.
// Low-level |sk_*| functions will be passed a type-specific wrapper to call it
// correctly.
OPENSSL_sk_cmp_func :: proc "c" (a: ^rawptr, b: ^rawptr) -> i32

// OPENSSL_sk_delete_if_func is the generic version of
// |sk_SAMPLE_delete_if_func|.
OPENSSL_sk_delete_if_func :: proc "c" (obj: rawptr, data: rawptr) -> i32

// The following function types call the above type-erased signatures with the
// true types.
OPENSSL_sk_call_free_func      :: proc "c" (OPENSSL_sk_free_func, rawptr)
OPENSSL_sk_call_copy_func      :: proc "c" (OPENSSL_sk_copy_func, rawptr) -> rawptr
OPENSSL_sk_call_cmp_func       :: proc "c" (OPENSSL_sk_cmp_func, rawptr, rawptr) -> i32
OPENSSL_sk_call_delete_if_func :: proc "c" (OPENSSL_sk_delete_if_func, rawptr, rawptr) -> i32
stack_st                       :: struct {}

// An OPENSSL_STACK contains an array of pointers. It is not designed to be used
// directly, rather the wrapper macros should be used.
OPENSSL_STACK :: stack_st

@(default_calling_convention="c")
foreign lib {
	// The following are raw stack functions. They implement the corresponding typed
	// |sk_SAMPLE_*| functions generated by |DEFINE_STACK_OF|. Callers shouldn't be
	// using them. Rather, callers should use the typed functions.
	OPENSSL_sk_new          :: proc(comp: OPENSSL_sk_cmp_func) -> ^OPENSSL_STACK ---
	OPENSSL_sk_new_null     :: proc() -> ^OPENSSL_STACK ---
	OPENSSL_sk_num          :: proc(sk: ^OPENSSL_STACK) -> c.size_t ---
	OPENSSL_sk_zero         :: proc(sk: ^OPENSSL_STACK) ---
	OPENSSL_sk_value        :: proc(sk: ^OPENSSL_STACK, i: c.size_t) -> rawptr ---
	OPENSSL_sk_set          :: proc(sk: ^OPENSSL_STACK, i: c.size_t, p: rawptr) -> rawptr ---
	OPENSSL_sk_free         :: proc(sk: ^OPENSSL_STACK) ---
	OPENSSL_sk_pop_free_ex  :: proc(sk: ^OPENSSL_STACK, call_free_func: OPENSSL_sk_call_free_func, free_func: OPENSSL_sk_free_func) ---
	OPENSSL_sk_insert       :: proc(sk: ^OPENSSL_STACK, p: rawptr, _where: c.size_t) -> c.size_t ---
	OPENSSL_sk_delete       :: proc(sk: ^OPENSSL_STACK, _where: c.size_t) -> rawptr ---
	OPENSSL_sk_delete_ptr   :: proc(sk: ^OPENSSL_STACK, p: rawptr) -> rawptr ---
	OPENSSL_sk_delete_if    :: proc(sk: ^OPENSSL_STACK, call_func: OPENSSL_sk_call_delete_if_func, func: OPENSSL_sk_delete_if_func, data: rawptr) ---
	OPENSSL_sk_find         :: proc(sk: ^OPENSSL_STACK, out_index: ^c.size_t, p: rawptr, call_cmp_func: OPENSSL_sk_call_cmp_func) -> i32 ---
	OPENSSL_sk_shift        :: proc(sk: ^OPENSSL_STACK) -> rawptr ---
	OPENSSL_sk_push         :: proc(sk: ^OPENSSL_STACK, p: rawptr) -> c.size_t ---
	OPENSSL_sk_pop          :: proc(sk: ^OPENSSL_STACK) -> rawptr ---
	OPENSSL_sk_dup          :: proc(sk: ^OPENSSL_STACK) -> ^OPENSSL_STACK ---
	OPENSSL_sk_sort         :: proc(sk: ^OPENSSL_STACK, call_cmp_func: OPENSSL_sk_call_cmp_func) ---
	OPENSSL_sk_is_sorted    :: proc(sk: ^OPENSSL_STACK) -> i32 ---
	OPENSSL_sk_set_cmp_func :: proc(sk: ^OPENSSL_STACK, comp: OPENSSL_sk_cmp_func) -> OPENSSL_sk_cmp_func ---
	OPENSSL_sk_deep_copy    :: proc(sk: ^OPENSSL_STACK, call_copy_func: OPENSSL_sk_call_copy_func, copy_func: OPENSSL_sk_copy_func, call_free_func: OPENSSL_sk_call_free_func, free_func: OPENSSL_sk_free_func) -> ^OPENSSL_STACK ---
}

// Deprecated private functions (hidden).
//
// TODO(crbug.com/boringssl/499): Migrate callers to the typed wrappers, or at
// least the new names and remove the old ones.
//
// TODO(b/290792019, b/290785937): Ideally these would at least be inline
// functions, so we do not squat the symbols.
_STACK :: OPENSSL_STACK

@(default_calling_convention="c")
foreign lib {
	// The following functions call the corresponding |OPENSSL_sk_*| function.
	sk_new_null :: proc() -> ^OPENSSL_STACK ---
	sk_num      :: proc(sk: ^OPENSSL_STACK) -> c.size_t ---
	sk_value    :: proc(sk: ^OPENSSL_STACK, i: c.size_t) -> rawptr ---
	sk_free     :: proc(sk: ^OPENSSL_STACK) ---
	sk_push     :: proc(sk: ^OPENSSL_STACK, p: rawptr) -> c.size_t ---
	sk_pop      :: proc(sk: ^OPENSSL_STACK) -> rawptr ---

	// sk_pop_free_ex calls |OPENSSL_sk_pop_free_ex|.
	//
	// TODO(b/291994116): Remove this.
	sk_pop_free_ex :: proc(sk: ^OPENSSL_STACK, call_free_func: OPENSSL_sk_call_free_func, free_func: OPENSSL_sk_free_func) ---

	// sk_pop_free behaves like |OPENSSL_sk_pop_free_ex| but performs an invalid
	// function pointer cast. It exists because some existing callers called
	// |sk_pop_free| directly.
	//
	// TODO(davidben): Migrate callers to bssl::UniquePtr and remove this.
	sk_pop_free :: proc(sk: ^OPENSSL_STACK, free_func: OPENSSL_sk_free_func) ---
}

// Built-in stacks.
OPENSSL_STRING                   :: cstring
stack_st_void                    :: struct {}
sk_void_free_func                :: proc "c" (rawptr)
sk_void_copy_func                :: proc "c" (rawptr) -> rawptr
sk_void_cmp_func                 :: proc "c" (^rawptr, ^rawptr) -> i32
sk_void_delete_if_func           :: proc "c" (rawptr, rawptr) -> i32
stack_st_OPENSSL_STRING          :: struct {}
sk_OPENSSL_STRING_free_func      :: proc "c" (cstring)
sk_OPENSSL_STRING_copy_func      :: proc "c" (cstring) -> cstring
sk_OPENSSL_STRING_cmp_func       :: proc "c" (^cstring, ^cstring) -> i32
sk_OPENSSL_STRING_delete_if_func :: proc "c" (cstring, rawptr) -> i32

